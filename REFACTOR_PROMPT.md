# Промпт для рефакторингу системи аутентифікації

## Контекст
У нас є веб-додаток для відстеження інстансів Lineage 2 з двома способами доступу:
1. **Telegram Web App** - автоматичний вхід через Telegram Mini App
2. **Веб-версія** - вхід через Telegram ID + пароль

## Поточні проблеми

### 1. Telegram Web App не працює правильно
- Коли користувач відкриває додаток в Telegram, він бачить ту саму сторінку логіну, що і в звичайній веб-версії
- Автоматичний вхід не спрацьовує
- Потрібно правильно визначати, чи додаток відкритий в Telegram Web App

### 2. Відновлення пароля не працює
- Код відновлення (4-значний) не надсилається або не працює
- Відновлення через старий пароль не працює
- Потрібно перевірити всю логіку відновлення

### 3. Зміна пароля не працює
- Зміна пароля в Settings не працює
- Потрібно перевірити автентифікацію та передачу headers

## Вимоги до нової системи

### Архітектура

1. **Чітке розділення сценаріїв:**
   - Telegram Web App: автоматичний вхід без пароля
   - Веб-версія: вхід через Telegram ID + пароль
   - Обидва способи мають працювати надійно

2. **Система автентифікації:**
   - JWT токени або сесії для веб-версії
   - Header-based автентифікація для API запитів
   - Правильна обробка помилок та логування

3. **Управління паролями:**
   - Реєстрація з встановленням пароля
   - Вхід з перевіркою пароля
   - Зміна пароля (потрібна автентифікація)
   - Відновлення пароля:
     - Через 4-значний код (надсилається через Telegram Bot)
     - Через старий пароль
   - Встановлення пароля для існуючих користувачів без пароля

### Технічні вимоги

1. **Backend (Node.js + Express + MongoDB):**
   - Правильна валідація Telegram Web App `initData` з перевіркою hash
   - Надійна система хешування паролів (bcrypt)
   - Правильна обробка помилок з детальним логуванням
   - Middleware для автентифікації
   - Валідація всіх вхідних даних

2. **Frontend (React + TypeScript):**
   - Правильне визначення Telegram Web App (перевірка `window.Telegram?.WebApp`)
   - Автоматичний вхід для Telegram Web App
   - Форми логіну/реєстрації для веб-версії
   - Правильна обробка помилок та відображення повідомлень
   - Захищені роути з перевіркою автентифікації

3. **Telegram Bot:**
   - Надійна відправка кодів відновлення пароля
   - Обробка помилок (якщо користувач не почав діалог)
   - Команда `/id` для отримання Telegram ID

### Специфіка реалізації

#### Telegram Web App Detection
```typescript
// Правильна перевірка Telegram Web App
const isTelegramWebApp = () => {
  if (typeof window === 'undefined') return false;
  return window.Telegram?.WebApp !== undefined;
};

// Перевірка initData
const hasValidInitData = () => {
  const tg = window.Telegram?.WebApp;
  return tg?.initData && tg.initData.trim() !== '';
};
```

#### Автоматичний вхід
- Перевіряти наявність Telegram Web App при завантаженні додатку
- Якщо є `initData` - автоматично відправляти на `/auth/webapp`
- Якщо успішно - зберігати користувача та перенаправляти на головну
- Якщо ні - показувати форму логіну

#### Відновлення пароля
- Генерувати 4-значний код (1000-9999)
- Зберігати код з терміном дії (15 хвилин)
- Надсилати через Telegram Bot API
- Обробляти помилки (403 - користувач не почав діалог)
- Валідувати код при скиданні пароля

#### Зміна пароля
- Вимагати автентифікацію (header `x-telegram-id`)
- Перевіряти старий пароль
- Валідувати новий пароль (мін. 6 символів)
- Хешувати перед збереженням

### Файли для перевірки та оновлення

**Backend:**
- `backend/src/routes/auth.ts` - всі endpoints аутентифікації
- `backend/src/middleware/auth.ts` - middleware для автентифікації
- `backend/src/models/User.ts` - модель користувача з методами

**Frontend:**
- `frontend/src/pages/Login.tsx` - сторінка логіну
- `frontend/src/pages/Register.tsx` - сторінка реєстрації
- `frontend/src/pages/ForgotPassword.tsx` - відновлення пароля
- `frontend/src/pages/SetPassword.tsx` - встановлення пароля
- `frontend/src/pages/Settings.tsx` - зміна пароля
- `frontend/src/context/AuthContext.tsx` - контекст автентифікації
- `frontend/src/api/axiosConfig.ts` - конфігурація axios з interceptors
- `frontend/src/App.tsx` - роутинг та захищені роути

**Telegram Bot:**
- `telegram-bot/src/index.ts` - команди бота та відправка кодів

### Критерії успіху

1. ✅ Telegram Web App автоматично логінить користувача без показу форми логіну
2. ✅ Веб-версія показує форму логіну та працює з паролем
3. ✅ Реєстрація створює користувача або встановлює пароль для існуючого
4. ✅ Відновлення пароля працює через код (4-значний) та старий пароль
5. ✅ Зміна пароля працює в Settings з правильною автентифікацією
6. ✅ Всі помилки обробляються та логуються
7. ✅ Паролі хешуються перед збереженням
8. ✅ Коди відновлення мають термін дії та валідуються

### Додаткові вимоги

- Використовувати сучасні практики безпеки
- Детальне логування для діагностики
- Правильна обробка edge cases
- Валідація всіх вхідних даних
- Зрозумілі повідомлення про помилки для користувача
- TypeScript типи для всіх функцій та компонентів

## Поточна структура проекту

**Backend:**
- Express.js сервер на порту 5001
- MongoDB з Mongoose
- Роути в `backend/src/routes/auth.ts`
- Middleware в `backend/src/middleware/auth.ts`
- Модель User в `backend/src/models/User.ts`

**Frontend:**
- React + TypeScript + Vite
- React Router для роутингу
- Context API для стану (AuthContext, LanguageContext)
- Axios для HTTP запитів

**Telegram Bot:**
- node-telegram-bot-api
- Polling режим
- Команди: /id, /profile, /global, /top, /zone

## Конкретні проблеми для вирішення

### Проблема 1: Telegram Web App не визначається
**Симптоми:**
- Коли відкриваєш додаток в Telegram, показується форма логіну замість автоматичного входу
- `window.Telegram?.WebApp` може бути undefined навіть в Telegram

**Можливі причини:**
- Скрипт Telegram Web App SDK завантажується асинхронно
- Перевірка відбувається до завантаження SDK
- Неправильна логіка визначення Telegram Web App

**Рішення:**
- Чекати на завантаження SDK перед перевіркою
- Використовувати `window.Telegram?.WebApp?.initData` для визначення
- Додати fallback з retry логікою
- Правильно обробляти випадок, коли initData порожній

### Проблема 2: Відновлення пароля не працює
**Симптоми:**
- Код не надсилається через бота
- Код не валідується при скиданні
- Відновлення через старий пароль не працює

**Можливі причини:**
- Бот не може надіслати повідомлення (користувач не почав діалог)
- Код не зберігається правильно в БД
- Термін дії коду перевіряється неправильно
- Старий пароль не перевіряється правильно

**Рішення:**
- Додати перевірку, чи користувач почав діалог з ботом
- Правильно обробляти помилки від Telegram Bot API
- Перевірити збереження коду в БД
- Додати логування на кожному етапі

### Проблема 3: Зміна пароля не працює
**Симптоми:**
- Зміна пароля в Settings не працює
- Помилки автентифікації

**Можливі причини:**
- Header `x-telegram-id` не передається правильно
- Middleware не читає header правильно
- Користувач не знаходиться в БД

**Рішення:**
- Перевірити, що `apiClient` правильно додає header
- Перевірити middleware `webAuth`
- Додати логування headers на backend
- Перевірити, що користувач існує в БД

## Завдання

Перероби систему аутентифікації, використовуючи найкращі сучасні практики, щоб усунути всі проблеми та зробити надійну, працюючу систему.

### План дій:

1. **Telegram Web App Detection (Пріоритет 1)**
   - Виправити визначення Telegram Web App
   - Додати правильну логіку очікування завантаження SDK
   - Перевірити автоматичний вхід
   - Додати детальне логування

2. **Відновлення пароля (Пріоритет 2)**
   - Перевірити відправку коду через бота
   - Виправити валідацію коду
   - Виправити відновлення через старий пароль
   - Додати обробку помилок

3. **Зміна пароля (Пріоритет 3)**
   - Перевірити передачу headers
   - Виправити middleware автентифікації
   - Додати логування

4. **Тестування та логування**
   - Додати детальне логування на всіх етапах
   - Протестувати всі сценарії
   - Перевірити обробку помилок

### Вимоги до коду:

- Код має бути чистим, читабельним та добре структурованим
- Використовувати TypeScript типи всюди
- Додавати коментарі для складних місць
- Обробляти всі edge cases
- Логувати важливі події для діагностики
- Повертати зрозумілі повідомлення про помилки

### Критерії успіху:

✅ Telegram Web App автоматично логінить без показу форми логіну
✅ Веб-версія показує форму логіну та працює
✅ Відновлення пароля працює через код (4-значний)
✅ Відновлення пароля працює через старий пароль
✅ Зміна пароля працює в Settings
✅ Всі помилки обробляються та логуються
✅ Код готовий до продакшену

Почни з виправлення Telegram Web App detection, потім перейди до відновлення пароля, потім до зміни пароля. Після кожної зміни перевіряй, що все працює.
